<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Monitoring Cuaca Universitas Amikom Purwokerto</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f6fbff;
      --card: #ffffff;
      --muted: #6b7684;
      --accent: #1e88e5;
      --accent-2: #0ea5b7;
      --glass: rgba(255,255,255,0.7);
      --shadow: 0 10px 30px rgba(30, 39, 63, 0.08);
      --radius: 12px;
      --hujan-red: #eb2f2f;
      --terang-green: #50dc7a;
    }
    *{box-sizing:border-box}
    body{
      font-family: "Inter", system-ui;
      margin:0;
      background:linear-gradient(180deg,var(--bg),#eef7ff 60%);
      color:#0f1724;
      padding:28px;
    }

    header{
      display:flex; gap:16px; align-items:center; justify-content:space-between;
      margin-bottom:22px;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .brand img{
      width:56px; height:56px; object-fit:cover; border-radius:10px; box-shadow:var(--shadow);
    }
    .brand .title{ font-weight:700; font-size:18px; }
    .brand .subtitle{ font-size:12px; color:var(--muted); margin-top:4px; }

    .controls { display:flex; gap:10px; align-items:center; }
    .btn {
      background:var(--accent); color:white; padding:8px 12px; border-radius:10px; border:0;
      font-weight:600; cursor:pointer; box-shadow:0 6px 18px rgba(30,136,229,0.18);
    }
    .btn.secondary { background:transparent; color:var(--accent); border:1px solid rgba(30,136,229,0.12); box-shadow:none; }

    .layout {
      display:grid; grid-template-columns: 1fr 420px; gap:20px;
    }

    .panel {
      background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow);
    }

    .cards {
      display:flex; gap:14px; margin-bottom:16px; align-items:stretch;
    }
    .card {
      flex:1; padding:14px; border-radius:12px;
      background:linear-gradient(180deg,#ffffff,#fbfdff);
      transition:transform .18s ease, box-shadow .18s ease; min-width:180px;
    }
    .card:hover { transform:translateY(-6px); box-shadow:0 18px 36px rgba(10,45,95,0.08);}
    .card .meta { font-size:13px; color:var(--muted); margin-bottom:8px; font-weight:600; }
    .card .big { font-size:26px; font-weight:700; color:#0b2b4a; }
    .card .small { font-size:12px; color:var(--muted); margin-top:8px; white-space:pre-line; }

    .hujan-line { margin-top:8px; font-size:13px; padding:8px; border-radius:10px; display:inline-block; }

    .charts-grid { display:grid; gap:14px; margin-top:8px; }

    .table-wrap { max-height:380px; overflow:auto; margin-top:12px; }
    table { width:100%; border-collapse:collapse; min-width:680px; }
    th, td { padding:10px 8px; border-bottom:1px solid #f1f6fb; font-size:13px; }
    th { color:var(--muted); font-weight:600; position:sticky; top:0; background:white; }

    @media (max-width:1000px){
      .layout{ grid-template-columns: 1fr; }
      .table-wrap table{ min-width:100%; }
    }
  </style>
</head>

<body>

<header>
  <div class="brand">
    <img src="https://pmb.amikompurwokerto.ac.id/assets/images/Logo.png">
    <div>
      <div class="title">Monitoring Cuaca Universitas Amikom Purwokerto</div>
      <div class="subtitle">Realtime • 3 Alat • Grafik & Tabel</div>
    </div>
  </div>

  <div class="controls">
    <div class="muted">Auto update</div>
    <button id="refreshBtn" class="btn secondary">Refresh</button>
    <button id="downloadBtn" class="btn">Download CSV</button>
  </div>
</header>

<div class="layout">
  <main>
    <div class="panel">

      <!-- CARD 3 ALAT -->
      <div class="cards">
        <div class="card" id="card1">
          <div class="meta">Pabuaran — Purwokerto Utara</div>
          <div class="big" id="c1-temp">-- °C</div>
          <div class="small" id="c1-info">Menunggu data...</div>
          <div id="c1-hujan" class="hujan-line">Hujan: --</div>
        </div>

        <div class="card" id="card2">
          <div class="meta">Universitas Amikom Purwokerto</div>
          <div class="big" id="c2-temp">-- °C</div>
          <div class="small" id="c2-info">Menunggu data...</div>
          <div id="c2-hujan" class="hujan-line">Hujan: --</div>
        </div>

        <div class="card" id="card3">
          <div class="meta">Bancarkembar — Purwokerto Utara</div>
          <div class="big" id="c3-temp">-- °C</div>
          <div class="small" id="c3-info">Menunggu data...</div>
          <div id="c3-hujan" class="hujan-line">Hujan: --</div>
        </div>
      </div>

      <!-- GRAFIK -->
      <div class="charts-grid">
        <div class="panel"><strong>Suhu (°C)</strong><canvas id="chartSuhu"></canvas></div>
        <div class="panel"><strong>Kelembapan (%)</strong><canvas id="chartKelembapan"></canvas></div>
        <div class="panel"><strong>Tekanan (hPa)</strong><canvas id="chartTekanan"></canvas></div>
        <div class="panel"><strong>Hujan (0=HUJAN / 1=TERANG)</strong><canvas id="chartHujan"></canvas></div>
      </div>

    </div>
  </main>

  <aside>
    <div class="panel">
      <strong>10 Log Terbaru</strong>
      <div style="margin:5px 0" class="muted">Pilih alat:</div>
      <select id="selectAlat" style="padding:8px; width:100%; border-radius:8px;">
        <option value="alat1_log_cuaca">Pabuaran</option>
        <option value="alat2_log_cuaca">Amikom</option>
        <option value="alat3_log_cuaca">Bancarkembar</option>
      </select>

      <div class="table-wrap">
        <table id="logTable">
          <thead>
            <tr>
              <th>Waktu</th>
              <th>Suhu</th>
              <th>Kelembapan</th>
              <th>Tekanan</th>
              <th>Hujan</th>
              <th>Kondisi</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="6" class="muted">Memuat...</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, query, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "ISI_API_KEY",
    authDomain: "prediksi-cuaca-f222d.firebaseapp.com",
    databaseURL: "https://prediksi-cuaca-f222d-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "prediksi-cuaca-f222d",
    storageBucket: "prediksi-cuaca-f222d.appspot.com",
    messagingSenderId: "ISI_SENDER_ID",
    appId: "ISI_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const ALATS = ["alat1_log_cuaca","alat2_log_cuaca","alat3_log_cuaca"];
  const perAlat = { alat1_log_cuaca:[], alat2_log_cuaca:[], alat3_log_cuaca:[] };

  function makeLabel(it){ return `${it.tanggal} ${it.waktu}`; }

  function hujanText(v){ return v=="0" ? "HUJAN" : "TERANG"; }

  function updateCards(){
    [1,2,3].forEach(i=>{
      const arr = perAlat[`alat${i}_log_cuaca`];
      const last = arr[arr.length-1];
      const T = document.getElementById(`c${i}-temp`);
      const I = document.getElementById(`c${i}-info`);
      const H = document.getElementById(`c${i}-hujan`);

      if(!last){
        T.textContent="-- °C";
        I.textContent="Menunggu...";
        H.textContent="Hujan: --";
      } else {
        T.textContent = last.suhu+" °C";
        I.textContent = `Kelembapan ${last.kelembapan}%\n${makeLabel(last)}`;
        H.textContent = "Hujan: "+hujanText(last.hujan);
      }
    });
  }

  // ===== GRAFIK =====
  function createChart(id){
    return new Chart(document.getElementById(id), {
      type: "line",
      data: { labels:[], datasets:[
        {label:"Alat 1", data:[], borderColor:"#1e88e5"},
        {label:"Alat 2", data:[], borderColor:"#0ea5b7"},
        {label:"Alat 3", data:[], borderColor:"#2563eb"},
      ]},
      options:{ responsive:true, tension:0.3 }
    });
  }

  const chartSuhu = createChart("chartSuhu");
  const chartKelembapan = createChart("chartKelembapan");
  const chartTekanan = createChart("chartTekanan");
  const chartHujan = createChart("chartHujan");

  function updateCharts(){
    const labels = new Set();
    ALATS.forEach(a=>perAlat[a].forEach(v=>labels.add(makeLabel(v))));
    const L = [...labels];

    chartSuhu.data.labels = L;
    chartKelembapan.data.labels = L;
    chartTekanan.data.labels = L;
    chartHujan.data.labels = L;

    ALATS.forEach((a,idx)=>{
      const arr = perAlat[a];
      const suhuArr = L.map(l=>arr.find(v=>makeLabel(v)==l)?.suhu || null);
      const kelArr  = L.map(l=>arr.find(v=>makeLabel(v)==l)?.kelembapan || null);
      const tekArr  = L.map(l=>arr.find(v=>makeLabel(v)==l)?.tekanan || null);
      const hujArr  = L.map(l=>arr.find(v=>makeLabel(v)==l)?.hujan || null);

      chartSuhu.data.datasets[idx].data = suhuArr;
      chartKelembapan.data.datasets[idx].data = kelArr;
      chartTekanan.data.datasets[idx].data = tekArr;
      chartHujan.data.datasets[idx].data = hujArr;
    });

    chartSuhu.update();
    chartKelembapan.update();
    chartTekanan.update();
    chartHujan.update();
  }

  // ===== TABEL =====
  function renderTable(){
    const alat = document.getElementById("selectAlat").value;
    const list = perAlat[alat].slice(-10).reverse();
    const tbody = document.querySelector("#logTable tbody");
    tbody.innerHTML="";

    list.forEach(v=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${makeLabel(v)}</td>
        <td>${v.suhu}</td>
        <td>${v.kelembapan}</td>
        <td>${v.tekanan}</td>
        <td>${hujanText(v.hujan)}</td>
        <td>${v.kondisi || "-"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.getElementById("selectAlat").addEventListener("change", renderTable);

  // LISTEN REALTIME
  ALATS.forEach(path=>{
    const q = query(ref(db,path), limitToLast(30));
    onValue(q, snap=>{
      const data = snap.val() || {};
      perAlat[path] = Object.keys(data).map(k=>data[k]);
      updateCards();
      updateCharts();
      renderTable();
    });
  });

  // DOWNLOAD CSV
  document.getElementById("downloadBtn").onclick = ()=>{
    let csv = "alat,waktu,suhu,kelembapan,tekanan,hujan,kondisi\n";
    ALATS.forEach(a=>{
      perAlat[a].forEach(v=>{
        csv += `${a},${makeLabel(v)},${v.suhu},${v.kelembapan},${v.tekanan},${v.hujan},${v.kondisi||""}\n`;
      });
    });
    const blob = new Blob([csv],{type:"text/csv"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download="log-cuaca.csv";
    link.click();
  };

  document.getElementById("refreshBtn").onclick=()=>{
    updateCards();
    updateCharts();
    renderTable();
  };
</script>

</body>
</html>
